<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>填寫表單</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[rgb(105,143,153)] min-h-screen flex items-center justify-center">
  <div class="bg-[rgb(106,167,182)] shadow-lg rounded-2xl p-8 w-full max-w-lg">
    <h1 class="text-2xl font-bold text-center mb-6">英聽、模考報名調查</h1>

    <!-- 座號 -->
    <div class="mb-5">
      <label for="seat" class="block text-xl font-medium mb-2">座號：</label>
      <select id="seat" class="w-full text-lg py-3 px-4 rounded-xl border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="" disabled selected>請選擇座號</option>
        <option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="31">31</option><option value="32">32</option><option value="33">33</option>
      </select>
    </div>

    <!-- 問題 1 -->
    <div class="mb-5">
      <label for="q1" class="block text-xl font-medium mb-2">第二次英語聽力測驗：</label>
      <select id="q1" class="w-full text-lg py-3 px-4 rounded-xl border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="" disabled selected>請選擇</option>
        <option value="1">報名 $350</option>
        <option value="2">不報名 $0</option>
      </select>
    </div>

    <!-- 問題 2 -->
    <div class="mb-5">
      <label for="q2" class="block text-xl font-medium mb-2">第二次學測模擬考試：</label>
      <select id="q2" class="w-full text-lg py-3 px-4 rounded-xl border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="" disabled selected>請選擇</option>
        <option value="1">社會組4科 $146</option>
        <option value="2">自然組4科 $153</option>
        <option value="3">5科(國英數A自社) $184</option>
        <option value="4">5科(國英數A數B社) $166</option>
        <option value="5">5科(國英數A數B自) $173</option>
        <option value="6">6科(國英數A數B自社) $204</option>
        <option value="7">不報名 $0</option>
      </select>
    </div>

    <!-- 問題 3 -->
    <div class="mb-5">
      <label for="q3" class="block text-xl font-medium mb-2">第三次學測模擬考試：</label>
      <select id="q3" class="w-full text-lg py-3 px-4 rounded-xl border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="" disabled selected>請選擇</option>
        <option value="1">社會組4科 $146</option>
        <option value="2">自然組4科 $153</option>
        <option value="3">5科(國英數A自社) $184</option>
        <option value="4">5科(國英數A數B社) $166</option>
        <option value="5">5科(國英數A數B自) $173</option>
        <option value="6">6科(國英數A數B自社) $204</option>
        <option value="7">不報名 $0</option>
      </select>
    </div>

    <div id="totalDisplay" class="text-lg  mb-4 text-black text-center">
      總額 = 0
    </div>

    <!-- 提交按鈕 -->
    <div class="text-center">
      <button id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-xl shadow-md transition">
        提交
      </button>
    </div>
  </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyADKLi9JJ8kMLJr07vQXEohZS2fVICKcSM",
        authDomain: "form-167b8.firebaseapp.com",
        projectId: "form-167b8",
        storageBucket: "form-167b8.firebasestorage.app",
        messagingSenderId: "950598111038",
        appId: "1:950598111038:web:f984ca62ed35f3498e666f"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const seatEl = document.getElementById("seat");
      const q1El = document.getElementById("q1");
      const q2El = document.getElementById("q2");
      const q3El = document.getElementById("q3");
      const totalDisplay = document.getElementById("totalDisplay");

      function extractPrice(text) {
        const match = text.match(/\$(\d+)/);
        return match ? parseInt(match[1]) : 0;
      }

      function updateTotal() {
        const q1Price = q1El.selectedOptions[0]?.text ? extractPrice(q1El.selectedOptions[0].text) : 0;
        const q2Price = q2El.selectedOptions[0]?.text ? extractPrice(q2El.selectedOptions[0].text) : 0;
        const q3Price = q3El.selectedOptions[0]?.text ? extractPrice(q3El.selectedOptions[0].text) : 0;
        totalDisplay.textContent = `總額 = ${q1Price + q2Price + q3Price}`;
      }

      q1El.addEventListener("change", updateTotal);
      q2El.addEventListener("change", updateTotal);
      q3El.addEventListener("change", updateTotal);

      document.getElementById("submitBtn").addEventListener("click", async () => {
        const seat = seatEl.value;
        const q1 = q1El.selectedOptions[0].text;
        const q2 = q2El.selectedOptions[0].text;
        const q3 = q3El.selectedOptions[0].text;

        if (!seat || !q1 || !q2 || !q3) {
          alert("請完整填寫！");
          return;
        }

        const totalPrice = extractPrice(q1) + extractPrice(q2) + extractPrice(q3);

        const userRef = doc(db, "users", seat);
        const docSnap = await getDoc(userRef);

        if (docSnap.exists()) {
          const overwrite = confirm("該座號已填寫，是否覆蓋？");
          if (!overwrite) return;
        }

        try {
          await setDoc(userRef, {
            Q1: q1,
            Q2: q2,
            Q3: q3,
            totalPrice: totalPrice,
            timestamp: new Date()
          });
          alert("提交成功！");
        } catch (e) {
          console.error("Error writing document: ", e);
          alert("提交失敗，請稍後再試！");
        }
      });
    </script>
</div>

  <div class="fixed bottom-4 right-4">
    <a href="https://youtu.be/dQw4w9WgXcQ?si=Q8d9YZNOpI9EUt2N" target="_blank" class="text-blue-600 hover:underline">
      <span class="underline">後台管理</span>
    </a>
  </div>
</body>
</html>